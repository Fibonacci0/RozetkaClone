{% extends "shop/_layout.html" %}
{% load static %}

{% block title %}Головна сторінка{% endblock %}

{% block content %}

<div class="flex w-full">

    <!-- Ліва панель: категорії або фільтри -->
    <div class="w-1/5 min-w-[160px] p-6 border-r border-gray-200">

        {% if not current_category %}
            <!-- Список категорій -->
            <ul class="text-left space-y-2 pl-4">
                {% if categories %}
                    {% for category in categories %}
                        {% if category.slug %}
                            <li>
                                <a href="{% url 'category_detail' category.slug %}" class="text-base text-gray-700 hover:text-orange-600">
                                    {% if category.icon %}
                                        <i class="fa-solid {{ category.icon }} text-lg"></i>
                                    {% else %}
                                        <i class="fa-solid fa-box"></i>
                                    {% endif %}
                                    {{ category.name }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <li class="text-gray-400">Категорій немає.</li>
                {% endif %}
            </ul>
        {% else %}
            <!-- Фільтри для обраної категорії -->
<div class="filters-sidebar mt-4 bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden" x-data="filterSidebar()">
    <!-- Header -->
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
        <h3 class="font-bold text-lg text-gray-800">Фільтри</h3>
    </div>

    <form method="get" class="p-4">
        <!-- Продавець -->
        {% if sellers %}
        <div class="mb-4">
            <button type="button" 
                    @click="toggleSection('seller')"
                    class="flex items-center justify-between w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <h4 class="text-sm font-semibold text-gray-800">Продавець</h4>
                <div class="flex items-center">
                    <span class="text-xs text-gray-500 mr-2">{{ sellers|length }}</span>
                    <svg class="w-4 h-4 transform transition-transform duration-200 text-gray-600"
                         :class="{ 'rotate-180': sections.seller }"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>
            
            <div x-show="sections.seller" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform -translate-y-2"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-y-0"
                 x-transition:leave-end="opacity-0 transform -translate-y-2"
                 class="mt-3 bg-white border border-gray-100 rounded-lg p-3 shadow-sm">
                
                <!-- Search input for sellers -->
                <div class="relative mb-3">
                    <input type="text" 
                           x-model="searches.seller"
                           placeholder="Пошук продавця..."
                           class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-gray-50">
                    <svg class="absolute right-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>

                <div class="space-y-2 max-h-48 overflow-y-auto">
                    {% for seller in sellers %}
                        <label class="flex items-center justify-between text-sm py-2 px-2 cursor-pointer hover:bg-orange-50 rounded-lg transition-colors group">
                            <div class="flex items-center">
                                <input type="checkbox" name="seller" value="{{ seller }}"
                                       {% if seller in selected_sellers or seller in default_sellers %}checked{% endif %}
                                       class="mr-3 w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                                <span class="text-gray-700 group-hover:text-orange-700">{{ seller }}</span>
                            </div>
                        </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Бренд -->
        {% if brands %}
        <div class="mb-4">
            <button type="button" 
                    @click="toggleSection('brand')"
                    class="flex items-center justify-between w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <h4 class="text-sm font-semibold text-gray-800">Бренд</h4>
                <div class="flex items-center">
                    <span class="text-xs text-gray-500 mr-2">{{ brands|length }}</span>
                    <svg class="w-4 h-4 transform transition-transform duration-200 text-gray-600"
                         :class="{ 'rotate-180': sections.brand }"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>
            
            <div x-show="sections.brand" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform -translate-y-2"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-y-0"
                 x-transition:leave-end="opacity-0 transform -translate-y-2"
                 class="mt-3 bg-white border border-gray-100 rounded-lg p-3 shadow-sm">
                
                <!-- Search input for brands -->
                <div class="relative mb-3">
                    <input type="text" 
                           x-model="searches.brand"
                           placeholder="Пошук бренду..."
                           class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-gray-50">
                    <svg class="absolute right-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>

                <div class="space-y-2 max-h-48 overflow-y-auto">
                    {% for brand in brands %}
                        <label class="flex items-center justify-between text-sm py-2 px-2 cursor-pointer hover:bg-orange-50 rounded-lg transition-colors group">
                            <div class="flex items-center">
                                {% if brand in selected_brands or brand in default_brands %}
                                    <div class="mr-3 w-4 h-4 bg-green-500 rounded flex items-center justify-center">
                                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                {% else %}
                                    <input type="checkbox" name="brand" value="{{ brand }}"
                                           class="mr-3 w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                                {% endif %}
                                <span class="text-gray-700 group-hover:text-orange-700">{{ brand }}</span>
                            </div>
                        </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Країна -->
        {% if countries %}
        <div class="mb-4">
            <button type="button" 
                    @click="toggleSection('country')"
                    class="flex items-center justify-between w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <h4 class="text-sm font-semibold text-gray-800">Країна</h4>
                <div class="flex items-center">
                    <span class="text-xs text-gray-500 mr-2">{{ countries|length }}</span>
                    <svg class="w-4 h-4 transform transition-transform duration-200 text-gray-600"
                         :class="{ 'rotate-180': sections.country }"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>
            
            <div x-show="sections.country" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform -translate-y-2"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-y-0"
                 x-transition:leave-end="opacity-0 transform -translate-y-2"
                 class="mt-3 bg-white border border-gray-100 rounded-lg p-3 shadow-sm">
                
                <div class="space-y-2 max-h-48 overflow-y-auto">
                    {% for country in countries %}
                        <label class="flex items-center justify-between text-sm py-2 px-2 cursor-pointer hover:bg-orange-50 rounded-lg transition-colors group">
                            <div class="flex items-center">
                                <input type="checkbox" name="country" value="{{ country }}"
                                       {% if country in selected_countries or country in default_countries %}checked{% endif %}
                                       class="mr-3 w-4 h-4 text-orange-500 border-gray-300 rounded focus:ring-orange-500">
                                <span class="text-gray-700 group-hover:text-orange-700">{{ country }}</span>
                            </div>
                        </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Ціна -->
        <div class="mb-6">
            <button type="button" 
                    @click="toggleSection('price')"
                    class="flex items-center justify-between w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <h4 class="text-sm font-semibold text-gray-800">Ціна</h4>
                <svg class="w-4 h-4 transform transition-transform duration-200 text-gray-600"
                     :class="{ 'rotate-180': sections.price }"
                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            
            <div x-show="sections.price" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform -translate-y-2"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-y-0"
                 x-transition:leave-end="opacity-0 transform -translate-y-2"
                 class="mt-3 bg-white border border-gray-100 rounded-lg p-4 shadow-sm">
                
                <!-- Input для мінімальної і максимальної ціни -->
                <div class="flex space-x-3 mb-4">
                    <div class="flex-1">
                        <label class="block text-xs text-gray-500 mb-1">Від</label>
                        <input type="number" id="min_price_input" name="min_price" min="0" max="100000"
                               value="{{ min_price_selected|default:'' }}" 
                               placeholder="0"
                               class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-gray-50">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs text-gray-500 mb-1">До</label>
                        <input type="number" id="max_price_input" name="max_price" min="0" max="100000"
                               value="{{ max_price_selected|default:'' }}" 
                               placeholder="100000"
                               class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent bg-gray-50">
                    </div>
                </div>

                <!-- Повзунок для максимальної ціни -->
                <div class="relative">
                    <input type="range"
                           id="price_slider"
                           min="0"
                           max="100000"
                           step="500"
                           value="{{ max_price_selected|default:100000 }}"
                           oninput="updatePriceFromSlider(this.value)"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>0₴</span>
                        <span>100,000₴</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Apply button -->
        <div class="bg-white border-t border-gray-200 p-4 -m-4 mt-0">
            <button type="submit" 
                    class="w-full py-3 px-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-medium rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                <span class="flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    Застосувати фільтри
                </span>
            </button>
        </div>
    </form>
</div>

<script>
function filterSidebar() {
    return {
        sections: {
            seller: false,
            brand: false, 
            country: false,
            price: true  // Price section open by default
        },
        searches: {
            seller: '',
            brand: '',
            country: ''
        },
        
        toggleSection(section) {
            this.sections[section] = !this.sections[section];
        }
    }
}

// Price slider functionality
function updatePriceFromSlider(value) {
    document.getElementById('max_price_input').value = value;
}

// Update slider when max price input changes
document.addEventListener('DOMContentLoaded', function() {
    const maxPriceInput = document.getElementById('max_price_input');
    const priceSlider = document.getElementById('price_slider');
    
    if (maxPriceInput && priceSlider) {
        maxPriceInput.addEventListener('input', function() {
            priceSlider.value = this.value;
        });
    }
});
</script>

<style>
.slider-thumb::-webkit-slider-thumb {
    appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f97316, #ea580c);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
    border: 2px solid white;
}

.slider-thumb::-moz-range-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f97316, #ea580c);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.3);
}

.slider-thumb::-webkit-slider-track {
    background: linear-gradient(to right, #f97316 0%, #f97316 var(--value, 50%), #e5e7eb var(--value, 50%), #e5e7eb 100%);
}
</style>
        {% endif %}
    </div>

    <!-- Права панель: промо та продукти -->
    <div class="flex-1 px-4">

        <!-- Промо карусель -->
        <div class="pt-5 border-b border-gray-200  pb-4 mb-6">
            {% include 'shop/_promo_carousel.html' %}
        </div>

        <!-- Продукти -->
        {% if not current_category %}
            <h2 class="text-2xl font-bold mx-6 mb-6 mt-6">Популярні товари</h2>
        {% else %}
            <h2 class="text-2xl font-bold mx-6 mb-6 mt-6">{{ current_category }}</h2>
        {% endif %}
        <div class="overflow-x-auto">
            <div class="flex flex-wrap gap-4 pb-6">
                {% if products %}
                    {% for product in products %}
                        {% if product.available and product.price >= min_price_selected|default:0 %}
                            <div class="w-[200px] bg-white rounded-2xl p-4 shadow-md hover:shadow-xl transition-all duration-300 ease-in-out transform hover:-translate-y-1 relative">

<!-- Favorite Icon -->
<div class="absolute top-2 right-2 text-orange-500 hover:text-orange-600 cursor-pointer"
     onclick="toggleFavorite({{ product.id }}, this)">
    {% if product.id in favorited_ids %}
        <i class="fas fa-heart"></i>   <!-- filled heart -->
    {% else %}
        <i class="far fa-heart"></i>   <!-- empty heart -->
    {% endif %}
</div>






                                <!-- Product Image -->
                                <a href="{% url 'product_detail' product.id %}">
                                    <img src="{{ product.get_image }}" alt="{{ product.name }}" class="w-full h-36 object-contain mb-2 rounded" loading="lazy">
                                </a>

                                <!-- Product Name -->
                                <p class="text-sm text-gray-700 text-left leading-snug break-words max-w-full">
                                    <a href="{% url 'product_detail' product.id %}">
                                        {{ product.name|truncatechars:40 }}
                                    </a>
                                </p>

                                <!-- Brand & Size -->
                                <p class="text-xs text-left text-gray-500 mt-1">
                                    {{ product.brand|default:"" }} {{ product.size|default:"" }}
                                </p>

                                <!-- Rating -->
                                <div class="flex items-center text-yellow-400 text-xs mt-1">
                                    {% with rating=product.rating|default:0 %}
                                        {% with full_stars=rating|floatformat:0 %}
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= full_stars %}
                                                    <i class="fa-solid fa-star mr-0.5"></i>
                                                {% else %}
                                                    <i class="fa-regular fa-star mr-0.5"></i>
                                                {% endif %}
                                            {% endfor %}
                                        {% endwith %}
                                        <span class="text-gray-800 ml-1">{{ rating|floatformat:1 }}</span>
                                        <span class="text-gray-500 ml-2">({{ product.review_count|default:"0" }} відгуків)</span>
                                    {% endwith %}
                                </div>

                                <!-- Old Price -->
                                <p class="text-sm text-left line-through text-gray-400 mt-2">
                                    {{ product.old_price|default:"" }}
                                </p>

                                <!-- Discount Price -->
                                <p class="text-lg font-bold text-left text-orange-600">
                                    {{ product.price }} ₴
                                </p>

                                <!-- Cart Icon -->
                                <div class="absolute bottom-2 right-2">
                                    <button class="text-gray-700 hover:text-green-600 text-lg">
                                        <i data-product-id="{{ product.id }}" data-product-name="{{ product.name }}" data-product-price="{{ product.price }}" data-product-image="{{ product.get_image }}" data-added="false" class="fas fa-shopping-basket"></i>
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-gray-500">Товари не знайдено.</p>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<script>
    // Синхронізація мін/макс полів та повзунка
    const minInput = document.getElementById('min_price_input');
    const maxInput = document.getElementById('max_price_input');
    const slider = document.getElementById('price_slider');

    minInput.addEventListener('input', () => {
        let minVal = parseInt(minInput.value) || 0;
        if(minVal > parseInt(maxInput.value)) minVal = parseInt(maxInput.value);
        minInput.value = minVal;
        slider.min = minVal;
    });

    maxInput.addEventListener('input', () => {
        let maxVal = parseInt(maxInput.value) || 100000;
        if(maxVal < parseInt(minInput.value)) maxVal = parseInt(minInput.value);
        maxInput.value = maxVal;
        slider.value = maxVal;
    });
</script>
<script>
async function toggleFavorite(productId, el) {
    try {
        let response = await fetch(`/favorite/${productId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest",
            }
        });

        let data = await response.json();

        if (data.login_required) {
            if (confirm("You need to log in to use favorites. Go to login page?")) {
                window.location.href = "/login_phone_request/?next=/" + window.location.pathname;
            }
            return;
        }
        let icon = el.querySelector("i");
        if (data.favorited) {
            icon.classList.remove("far");
            icon.classList.add("fas");
        } else {
            icon.classList.remove("fas");
            icon.classList.add("far");
        }
    } catch (err) {
        console.error("Error toggling favorite:", err);
    }
}

// Simple helper for CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        let cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<!-- Smartsupp Live Chat script -->
<script type="text/javascript">
    var _smartsupp = _smartsupp || {};
    _smartsupp.key = '7ce9c2b5f2c9c9c01a16300e69af6d6e6c7d2542';
    window.smartsupp||(function(d) {
      var s,c,o=smartsupp=function(){ o._.push(arguments)};o._=[];
      s=d.getElementsByTagName('script')[0];c=d.createElement('script');
      c.type='text/javascript';c.charset='utf-8';c.async=true;
      c.src='https://www.smartsuppchat.com/loader.js?';s.parentNode.insertBefore(c,s);
    })(document);
    </script>
    <noscript> Powered by <a href=“https://www.smartsupp.com” target=“_blank”>Smartsupp</a></noscript>
    

{% endblock %}
