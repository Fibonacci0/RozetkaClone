{% extends "shop/_layout.html" %}
{% load shop_extras %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
  <div class="container mx-auto p-6">
    <!-- Breadcrumb -->
    <div class="mb-6">
      <nav class="flex text-sm text-gray-500">
        <a href="{% url 'home' %}" class="hover:text-green-600">Головна</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">{{ product.name }}</span>
      </nav>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Product Images -->
      <div x-data="{ activeImage: 0 }" class="relative">
        <!-- Main Image Container -->
        <div class="bg-white rounded-2xl overflow-hidden shadow-sm border p-4 mb-4">
          <div class="relative aspect-square flex items-center justify-center">
            {% if product.images.all %}
              {% for image in product.images.all %}
                <img 
                  x-show="activeImage === {{ forloop.counter0 }}" 
                  src="{{ image.url }}" 
                  alt="{{ product.name }}" 
                  class="object-contain max-h-full max-w-full transition-transform duration-300 hover:scale-105"
                >
              {% endfor %}
            {% else %}
              <img src="{{ product.get_image }}" alt="{{ product.name }}" 
                class="object-contain max-h-full max-w-full">
            {% endif %}
          </div>
        </div>

        <!-- Thumbnails -->
        {% if product.images.all %}
        <div class="flex space-x-3">
          {% for image in product.images.all %}
          <div 
            class="w-16 h-16 bg-white rounded-lg border-2 cursor-pointer transition-all duration-200"
            :class="activeImage === {{ forloop.counter0 }} ? 'border-green-500 ring-1 ring-green-500' : 'border-gray-200 hover:border-green-300'"
            @click="activeImage = {{ forloop.counter0 }}"
          >
            <img 
              src="{{ image.url }}" 
              alt="thumb {{ forloop.counter }}" 
              class="w-full h-full object-cover rounded-md"
            >
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- Product Info -->
      <div class="bg-white rounded-2xl p-6 shadow-sm border h-fit">
        <!-- Product Title -->
        <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-4 leading-tight">
          {{ product.name }}
        </h1>

        <!-- Rating and Reviews -->
        <div class="flex items-center space-x-3 mb-6">
          {% if product.rating %}
          <div class="flex items-center space-x-1">
            <div class="flex text-yellow-400">
              {% for i in "12345" %}
                {% if forloop.counter <= product.rating %}
                  <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20">
                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                  </svg>
                {% else %}
                  <svg class="w-5 h-5 fill-current text-gray-300" viewBox="0 0 20 20">
                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                  </svg>
                {% endif %}
              {% endfor %}
            </div>
            <span class="text-sm font-medium text-gray-900">{{ product.rating }}</span>
            <span class="text-sm text-gray-500">({{ product.review_count }} відгуків)</span>
          </div>
          {% endif %}
        </div>

        <!-- Price -->
        <div class="mb-6">
          <div class="flex items-baseline space-x-3">
            <span class="text-3xl font-bold text-green-600">${{ product.price }}</span>
            {% if product.old_price %}
            <span class="text-lg text-gray-400 line-through">${{ product.old_price }}</span>
            {% endif %}
          </div>
        </div>

        <!-- Stock Status -->
        <div class="mb-6">
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span class="text-green-600 font-medium">В наявності</span>
          </div>
        </div>

        <!-- Color Selection -->
        {% if product.colors %}
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-900 mb-3">Колір:</label>
          <div class="flex space-x-3">
            {% for color in product.colors %}
            <button 
              class="w-10 h-10 rounded-full border-2 border-gray-300 hover:border-green-500 focus:border-green-500 transition-colors duration-200 relative"
              style="background: {{ color }};"
            >
              <span class="sr-only">{{ color }}</span>
            </button>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Size Selection -->
        {% if product.sizes %}
        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-900 mb-3">Розмір:</label>
          <select class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-900 focus:ring-2 focus:ring-green-500 focus:border-transparent">
            {% for size in product.sizes %}
            <option value="{{ size }}">{{ size }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="space-y-3">
          {% if cart %}
          <a href="{% url 'payment_page' %}" class="block">
            <button class="w-full bg-green-600 hover:bg-green-700 text-white py-4 px-6 rounded-xl font-semibold text-lg transition-colors duration-200 transform hover:scale-[0.98]">
              Купити зараз
            </button>
          </a>
          {% else %}
          <button class="w-full bg-green-600 hover:bg-green-700 text-white py-4 px-6 rounded-xl font-semibold text-lg transition-colors duration-200 transform hover:scale-[0.98]">
            Купити зараз
          </button>
          {% endif %}
          
          <button class="w-full border-2 border-gray-300 hover:border-green-500 text-gray-900 hover:text-green-600 py-4 px-6 rounded-xl font-semibold text-lg transition-all duration-200">
            Додати в кошик
          </button>
        </div>

        <!-- Quick Info -->
        <div class="mt-8 pt-6 border-t border-gray-200">
          <div class="space-y-3 text-sm text-gray-600">
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <span>Безкоштовна доставка від 1000 грн</span>
            </div>
            {% comment %} <div class="flex items-center space-x-3">
              <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <span>Гарантія якості</span>
            </div> {% endcomment %}
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
              </svg>
              <span>Обмін та повернення до 14 днів</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Details Tabs -->
    <div x-data="{ tab: 'desc' }" class="mt-12">
      <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200">
          <nav class="flex space-x-8 px-6">
            <button 
              @click="tab='desc'"
              :class="tab==='desc' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap transition-colors duration-200"
            >
              Опис
            </button>
            <button 
              @click="tab='reviews'"
              :class="tab==='reviews' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap transition-colors duration-200"
            >
              Відгуки {% if product.review_count %}({{ product.review_count }}){% endif %}
            </button>
          </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
          <!-- Description Tab -->
          <div x-show="tab==='desc'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
            <div class="prose max-w-none text-gray-700">
              <p class="leading-relaxed">{{ product.description }}</p>
            </div>
          </div>

          <!-- Reviews Tab -->
          <div x-show="tab==='reviews'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
            <div class="space-y-6">
              <div class="flex items-center justify-between">
                <h3 class="text-xl font-semibold text-gray-900">Відгуки покупців</h3>
                
                {% if user.is_authenticated and user_review_exists %}
                <button class="bg-gray-300 text-gray-500 px-4 py-2 rounded-lg cursor-not-allowed">
                  Ви вже залишили відгук
                </button>
                {% else %}
                <a href="{% url 'add_review' product.id %}"
                  class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                  Додати відгук
                </a>
                {% endif %}
              </div>

              <!-- Review Summary -->
              {% if product.review_count %}
              <div class="bg-gray-50 rounded-xl p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div class="flex items-center space-x-4">
                    <div class="text-center">
                      <div class="text-4xl font-bold text-gray-900">{{ product.rating }}</div>
                      <div class="flex justify-center mt-1">
                        {% for i in "12345" %}
                          {% if forloop.counter <= product.rating %}
                            <svg class="w-4 h-4 text-yellow-400 fill-current" viewBox="0 0 20 20">
                              <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                            </svg>
                          {% else %}
                            <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20">
                              <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                            </svg>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <div class="text-sm text-gray-500 mt-1">{{ product.review_count }} відгуків</div>
                    </div>
                  </div>
                  
                  <div class="col-span-2">
                    {% for i in "54321" %}
                    <div class="flex items-center space-x-3 mb-2">
                      <span class="text-sm text-gray-600 w-8">{{ i }} ★</span>
                      <div class="flex-1 bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-400 h-2 rounded-full transition-all duration-300" 
                             style="width: {{ star_percentages|dict_get:i }}%"></div>
                      </div>
                      <span class="text-sm text-gray-500 w-8">{{ star_counts|dict_get:i }}</span>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
              {% endif %}

              <!-- Reviews List -->
              <div class="space-y-4">
                {% for review in reviews %}
                  <div class="border border-gray-200 rounded-xl p-6">
                    {% include 'shop/_review.html' %}
                  </div>
                {% empty %}
                  <div class="text-center py-8">
                    <div class="text-gray-400 text-6xl mb-4">💬</div>
                    <p class="text-gray-500">Відгуків поки що немає.</p>
                    <p class="text-sm text-gray-400 mt-2">Будьте першим, хто залишить відгук про цей товар!</p>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products Section -->
    <div class="mt-12">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Схожі товари</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        {% for related_product in random_products %}
        <div class="bg-white rounded-xl overflow-hidden shadow-sm border hover:shadow-lg transition-shadow duration-300">
          <a href="{% url 'product_detail' related_product.id %}" class="block">
            <!-- Product Image -->
            <div class="aspect-square bg-gray-50 overflow-hidden">
              <img 
                src="{{ related_product.get_image }}" 
                alt="{{ related_product.name }}"
                class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
              >
            </div>
            
            <!-- Product Info -->
            <div class="p-4">
              <h3 class="font-semibold text-gray-900 text-sm mb-2 line-clamp-2 leading-tight">
                {{ related_product.name }}
              </h3>
              
              <!-- Rating -->
              {% if related_product.rating %}
              <div class="flex items-center space-x-1 mb-2">
                <div class="flex text-yellow-400">
                  {% for i in "12345" %}
                    {% if forloop.counter <= related_product.rating %}
                      <svg class="w-3 h-3 fill-current" viewBox="0 0 20 20">
                        <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                      </svg>
                    {% else %}
                      <svg class="w-3 h-3 fill-current text-gray-300" viewBox="0 0 20 20">
                        <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                      </svg>
                    {% endif %}
                  {% endfor %}
                </div>
                <span class="text-xs text-gray-500">({{ related_product.review_count }})</span>
              </div>
              {% endif %}
              
              <!-- Price -->
              <div class="flex items-center space-x-2">
                <span class="font-bold text-green-600">{{ related_product.price }}₴</span>
                {% if related_product.old_price %}
                <span class="text-sm text-gray-400 line-through">{{ related_product.old_price }}₴</span>
                {% endif %}
              </div>
            </div>
          </a>
          
          <!-- Quick Add Button -->
          <div class="px-4 pb-4">
            <button class="w-full bg-gray-100 hover:bg-green-600 hover:text-white text-gray-700 py-2 px-3 rounded-lg text-sm font-medium transition-all duration-200">
              Додати в кошик
            </button>
          </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-8">
          <p class="text-gray-500">Схожі товари не знайдені</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Back Button -->
    <div class="mt-12 text-center">
      <a href="{% url 'home' %}" 
         class="inline-flex items-center space-x-2 text-green-600 hover:text-green-700 font-medium transition-colors duration-200">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <span>Повернутися на головну</span>
      </a>
    </div>
  </div>
</div>
{% endblock %}